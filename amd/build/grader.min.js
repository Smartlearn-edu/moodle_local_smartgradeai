define(['jquery', 'core/ajax', 'core/notification', 'core/str'], function ($, Ajax, Notification, Str) {
    return {
        init: function (params) {
            console.log('=== AUTOGRADEHELPER AMD MODULE INIT ===');
            console.log('Smart Grade AI: Init called with params:', params, 'type:', typeof params);

            var assignmentId, courseId;

            // Handle both calling conventions:
            // 1. Moodle sometimes passes just the first parameter as a number: init(15)
            // 2. Sometimes it passes an object: init({assignmentid: 15, courseid: 155})
            if (typeof params === 'number') {
                // Direct number passed
                assignmentId = params;
                courseId = null;
                console.log('AUTOGRADEHELPER: Received assignmentId as direct number:', assignmentId);
            } else if (params && typeof params === 'object') {
                // Object passed
                assignmentId = params.assignmentid;
                courseId = params.courseid;
                console.log('AUTOGRADEHELPER: Received params as object, assignmentId:', assignmentId, 'courseId:', courseId);
            } else {
                // Invalid or no params - try URL fallback
                console.warn('AUTOGRADEHELPER: No valid params, trying URL extraction');
                var urlParams = new URLSearchParams(window.location.search);
                var urlId = urlParams.get('id');
                assignmentId = urlId ? parseInt(urlId) : null;
                courseId = null;
                console.log('AUTOGRADEHELPER: Extracted from URL id:', assignmentId);
            }

            console.log('AUTOGRADEHELPER: Final assignmentId:', assignmentId, 'courseId:', courseId);

            if (!assignmentId) {
                console.error('AUTOGRADEHELPER: No assignment ID available! Cannot initialize button.');
                return;
            }

            // Wait for the DOM to be ready
            $(document).ready(function () {
                console.log('Smart Grade AI: DOM Ready');

                // Try to find the grading actions container.
                var container = $('.submissionstatustable').first();
                console.log('Smart Grade AI: Checking .submissionstatustable', container.length);

                if (container.length === 0) {
                    container = $('.gradingtable').first();
                    console.log('Smart Grade AI: Checking .gradingtable', container.length);
                }

                if (container.length === 0) {
                    // Try finding the grading actions form or region
                    container = $('.grading-actions-form');
                    console.log('Smart Grade AI: Checking .grading-actions-form', container.length);
                }

                if (container.length === 0) {
                    container = $('[role="main"]');
                    console.log('Smart Grade AI: Checking [role="main"]', container.length);
                }

                Str.get_string('grade_with_ai_button', 'local_smartgradeai').done(function (buttonLabel) {
                    var button = $('<button class="btn btn-primary ml-2">' + buttonLabel + '</button>');

                    button.click(function (e) {
                        e.preventDefault();
                        button.prop('disabled', true);
                        console.log('=== AUTOGRADEHELPER BUTTON CLICKED ===');
                        console.log('Smart Grade AI: Button clicked');
                        console.log('Will send assignmentId:', assignmentId, 'type:', typeof assignmentId);

                        var ajaxArgs = {
                            assignmentid: assignmentId
                        };
                        console.log('AJAX args object:', ajaxArgs);
                        console.log('AJAX args JSON:', JSON.stringify(ajaxArgs));

                        var promises = Ajax.call([{
                            methodname: 'local_smartgradeai_trigger_grading',
                            args: ajaxArgs
                        }]);
                        console.log('Ajax.call executed, promises:', promises);

                        promises[0].done(function (response) {
                            console.log('Smart Grade AI: Response', response);
                            if (response.success) {
                                Str.get_string('trigger_success', 'local_smartgradeai').done(function (msg) {
                                    Notification.alert('Success', msg, 'Ok');
                                });
                            } else {
                                Str.get_string('trigger_error', 'local_smartgradeai', response.message).done(function (msg) {
                                    Notification.alert('Error', msg, 'Ok');
                                });
                            }
                        }).fail(function (ex) {
                            console.error('Smart Grade AI: Failed', ex);
                            Notification.exception(ex);
                        })
                            .always(function () {
                                button.prop('disabled', false);
                            });
                    });

                    // Insert button
                    if ($('.submissionlinks').length) {
                        $('.submissionlinks').append(button);
                    } else if ($('.grading-actions-form').length) {
                        $('.grading-actions-form').append(button);
                    } else {
                        container.before(button);
                    }
                    console.log('Smart Grade AI: Button appended');
                });
            });
        }
    };
});